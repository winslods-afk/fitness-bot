# Решение проблемы потери данных после деплоя

## Проблема

После деплоя программы тренировок удаляются, даже если volume настроен.

## Анализ логов

Из ваших логов видно:
- `Database URL: sqlite+aiosqlite:///data/fitness_bot.db` - используется SQLite
- Volume монтируется: `Mounting volume on: /var/lib/containers/...`
- Но данные все равно теряются

## Причина

Возможные причины:
1. **Volume монтируется, но база данных создается заново при каждом деплое**
2. **База данных создается в другом месте, не в volume**
3. **Volume не сохраняется между деплоями**

## Решение: Использовать PostgreSQL (рекомендуется)

**Самое надежное решение - использовать PostgreSQL:**

### Шаг 1: Добавьте PostgreSQL в Railway

1. **Откройте Railway Dashboard:**
   - https://railway.app
   - Выберите ваш проект

2. **Добавьте PostgreSQL:**
   - Нажмите **"+ New"** → **"Database"** → **"Add PostgreSQL"**
   - Railway автоматически создаст PostgreSQL сервис
   - Railway автоматически создаст переменную `DATABASE_URL`

3. **Проверьте переменные:**
   - Railway Dashboard → ваш сервис бота → "Variables"
   - Должна быть переменная `DATABASE_URL`

### Шаг 2: Деплой

Railway автоматически задеплоит изменения. После деплоя:

1. **Проверьте логи:**
   ```bash
   railway logs
   ```
   
   Должно быть:
   ```
   DATABASE_URL provided: True
   Using PostgreSQL database
   ✅ База данных инициализирована
   ```

2. **Проверьте данные:**
   - Добавьте тестовую программу через бота
   - Сделайте новый деплой (измените README.md и запушьте)
   - Проверьте, что программа осталась

### Шаг 3: Проверка через DBeaver

Подключитесь к PostgreSQL через DBeaver и проверьте данные:
- См. [DBEAVER_RAILWAY_CONNECTION.md](DBEAVER_RAILWAY_CONNECTION.md)

## Альтернативное решение: Исправить SQLite с volume

Если хотите использовать SQLite с volume:

### Шаг 1: Проверьте volume

```bash
railway volume list
```

Должен быть volume с:
- Mount path: `/data`
- Attached to: `web` (или имя вашего сервиса)

### Шаг 2: Проверьте базу данных

```bash
# Подключитесь к контейнеру
railway run bash

# Проверьте, существует ли файл базы данных
ls -la /data/fitness_bot.db

# Проверьте размер файла
du -h /data/fitness_bot.db

# Проверьте данные
sqlite3 /data/fitness_bot.db "SELECT * FROM users;"
sqlite3 /data/fitness_bot.db "SELECT * FROM sessions;"
```

### Шаг 3: Проверьте логи после деплоя

После следующего деплоя проверьте логи:

```bash
railway logs
```

Ищите:
```
Volume /data check: exists=True, writable=True
✅ Using SQLite on Railway: /data/fitness_bot.db
✅ Volume /data настроен правильно - данные будут сохраняться
✅ База данных создана: /data/fitness_bot.db (размер: XXX байт)
```

Если видите:
```
❌ Volume /data недоступен!
⚠️ Используется fallback путь (данные могут теряться!)
```

Тогда volume не работает правильно.

## Рекомендация

**Используйте PostgreSQL** - это самое надежное решение:
- ✅ Автоматическое сохранение данных
- ✅ Не нужен volume
- ✅ Легкий доступ через DBeaver
- ✅ Автоматические бэкапы
- ✅ Масштабируемость
- ✅ Данные сохраняются между деплоями автоматически

## Проверка после исправления

1. **Добавьте тестовую программу:**
   - Откройте бота
   - Добавьте программу с 1 днем и 1 упражнением
   - Сохраните программу

2. **Сделайте новый деплой:**
   - Измените что-то в коде (например, README.md)
   - Закоммитьте и запушьте:
     ```bash
     git add README.md
     git commit -m "Test deploy"
     git push
     ```

3. **Проверьте данные:**
   - После деплоя откройте бота
   - Проверьте, что программа осталась
   - Если программа осталась - ✅ проблема решена!
   - Если программа удалилась - проверьте логи и настройки

## Дополнительная диагностика

После следующего деплоя проверьте логи - там будет подробная информация о:
- Определении окружения Railway
- Проверке volume
- Пути к базе данных
- Размере файла базы данных

Это поможет понять, в чем именно проблема.

