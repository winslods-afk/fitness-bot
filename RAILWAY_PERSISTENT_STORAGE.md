# Настройка персистентного хранилища для базы данных на Railway

## Проблема
При каждом новом деплое на Railway контейнер пересоздается, и все данные в файловой системе теряются, включая базу данных SQLite.

## Решение
Использовать Railway Volume (постоянное хранилище) для сохранения базы данных между деплоями.

## Инструкция по настройке

### Вариант 1: Через Railway Dashboard (рекомендуется)

1. **Откройте ваш проект на Railway**
   - Перейдите на https://railway.app
   - Выберите ваш проект

2. **Создайте Volume**
   - В вашем сервисе нажмите на вкладку **"Volumes"**
   - Нажмите **"+ New Volume"**
   - Назовите volume: `database-storage`
   - Нажмите **"Add Volume"**

3. **Привяжите Volume к сервису**
   - После создания volume, нажмите на него
   - В разделе **"Mounts"** нажмите **"+ New Mount"**
   - Выберите ваш сервис (где запущен бот)
   - Укажите **Mount Path**: `/data`
   - Нажмите **"Add Mount"**

4. **Проверьте конфигурацию**
   - Убедитесь, что в `railway.json` есть секция `volumes`:
   ```json
   {
     "volumes": [
       {
         "name": "database-storage",
         "mountPath": "/data"
       }
     ]
   }
   ```

5. **Деплой**
   - Сделайте коммит и пуш изменений
   - Railway автоматически применит конфигурацию

### Вариант 2: Через Railway CLI

```bash
# Установите Railway CLI (если еще не установлен)
npm i -g @railway/cli

# Войдите в Railway
railway login

# Свяжите проект
railway link

# Создайте volume
railway volume create database-storage

# Привяжите volume к сервису
railway volume mount database-storage --mount-path /data
```

## Как это работает

1. **При первом деплое:**
   - Railway создает volume `database-storage`
   - Монтирует его в `/data` внутри контейнера
   - Бот создает базу данных в `/data/fitness_bot.db`

2. **При последующих деплоях:**
   - Railway сохраняет volume между деплоями
   - База данных остается в `/data/fitness_bot.db`
   - Все данные сохраняются

## Проверка

После настройки volume:

1. **Проверьте логи при старте:**
   ```
   База данных инициализирована
   ```

2. **Добавьте тестовую программу** через бота

3. **Сделайте новый деплой** (например, измените README и закоммитьте)

4. **Проверьте, что программа осталась** после деплоя

## Важные замечания

- ⚠️ **Volume создается один раз** и сохраняется между деплоями
- ⚠️ **Если вы удалите volume**, все данные будут потеряны
- ⚠️ **Volume привязан к проекту**, не к сервису
- ✅ **Резервное копирование**: Используйте команду `/export_db` для скачивания базы данных

## Альтернативное решение: PostgreSQL

Если вы хотите более надежное решение, можно использовать PostgreSQL:

1. Добавьте PostgreSQL сервис в Railway
2. Получите `DATABASE_URL` из переменных окружения
3. Обновите `app/config.py` для использования PostgreSQL вместо SQLite

Но для текущего проекта SQLite с Volume вполне достаточно.

## Устранение проблем

### База данных все еще сбрасывается

1. Проверьте, что volume создан и привязан:
   - Railway Dashboard → Ваш сервис → Volumes
   - Должен быть volume `database-storage` с mount path `/data`

2. Проверьте логи при старте:
   ```bash
   railway logs
   ```
   Должно быть: `База данных инициализирована`

3. Проверьте переменные окружения:
   ```bash
   railway variables
   ```
   `RAILWAY_ENVIRONMENT` или `RAILWAY` должны быть установлены

### Volume не монтируется

1. Убедитесь, что в `railway.json` есть секция `volumes`
2. Перезапустите сервис через Railway Dashboard
3. Проверьте, что mount path указан как `/data`

