# Настройка персистентного хранилища для базы данных на Railway

## Проблема
При каждом новом деплое на Railway контейнер пересоздается, и все данные в файловой системе теряются, включая базу данных SQLite.

## Решение
Использовать Railway Volume (постоянное хранилище) для сохранения базы данных между деплоями.

## Инструкция по настройке

### Вариант 1: Через Railway CLI (рекомендуется)

Это самый надежный способ создать volume:

```bash
# Установите Railway CLI (если еще не установлен)
npm i -g @railway/cli

# Войдите в Railway
railway login

# Свяжите проект (если еще не связан)
cd C:\Users\Roman\fitness-bot
railway link

# Создайте volume
railway volume create database-storage

# Привяжите volume к сервису (замените SERVICE_NAME на имя вашего сервиса)
# Сначала узнайте имя сервиса:
railway service

# Затем привяжите volume (если сервис называется "web", используйте "web"):
railway volume mount database-storage --service web --mount-path /data
```

**Если не знаете имя сервиса:**
```bash
# Посмотрите список сервисов
railway service list
```

### Вариант 2: Через Railway Dashboard

**Важно:** В некоторых случаях в Dashboard может не быть прямого доступа к созданию volumes. В этом случае используйте **Вариант 1 (CLI)**.

Если в Dashboard есть возможность:

1. **Откройте ваш проект на Railway**
   - Перейдите на https://railway.app
   - Выберите ваш проект

2. **Найдите раздел Volumes**
   - В настройках проекта или сервиса найдите раздел **"Volumes"**
   - Если раздела нет, используйте CLI (Вариант 1)

3. **Создайте и привяжите Volume**
   - Следуйте инструкциям в интерфейсе
   - Назовите volume: `database-storage`
   - Укажите Mount Path: `/data`
   - Выберите ваш сервис (например, "web")

4. **Проверьте конфигурацию**
   - Убедитесь, что в `railway.json` есть секция `volumes`
   - Это уже настроено в проекте

5. **Деплой**
   - Сделайте коммит и пуш изменений
   - Railway автоматически применит конфигурацию

## Как это работает

1. **При первом деплое:**
   - Railway создает volume `database-storage`
   - Монтирует его в `/data` внутри контейнера
   - Бот создает базу данных в `/data/fitness_bot.db`

2. **При последующих деплоях:**
   - Railway сохраняет volume между деплоями
   - База данных остается в `/data/fitness_bot.db`
   - Все данные сохраняются

## Проверка

После настройки volume:

1. **Проверьте логи при старте:**
   ```
   База данных инициализирована
   ```

2. **Добавьте тестовую программу** через бота

3. **Сделайте новый деплой** (например, измените README и закоммитьте)

4. **Проверьте, что программа осталась** после деплоя

## Важные замечания

- ⚠️ **Volume создается один раз** и сохраняется между деплоями
- ⚠️ **Если вы удалите volume**, все данные будут потеряны
- ⚠️ **Volume привязан к проекту**, не к сервису
- ✅ **Резервное копирование**: Используйте команду `/export_db` для скачивания базы данных

## Альтернативное решение: PostgreSQL

Если вы хотите более надежное решение, можно использовать PostgreSQL:

1. Добавьте PostgreSQL сервис в Railway
2. Получите `DATABASE_URL` из переменных окружения
3. Обновите `app/config.py` для использования PostgreSQL вместо SQLite

Но для текущего проекта SQLite с Volume вполне достаточно.

## Устранение проблем

### База данных все еще сбрасывается

1. Проверьте, что volume создан и привязан:
   - Railway Dashboard → Ваш сервис → Volumes
   - Должен быть volume `database-storage` с mount path `/data`

2. Проверьте логи при старте:
   ```bash
   railway logs
   ```
   Должно быть: `База данных инициализирована`

3. Проверьте переменные окружения:
   ```bash
   railway variables
   ```
   `RAILWAY_ENVIRONMENT` или `RAILWAY` должны быть установлены

### Volume не монтируется

1. Убедитесь, что в `railway.json` есть секция `volumes`
2. Перезапустите сервис через Railway Dashboard
3. Проверьте, что mount path указан как `/data`

